import{u as P,a as D,s as c,j as e,L as E}from"./index-CufYMjLy.js";import{r as n,A as M,q as T,e as y,d as N,j as $,X as I,P as U,U as L}from"./ui-FliD9Jbj.js";import{S as z}from"./SmartStatusBadge-BftyY1xO.js";import{C as F}from"./ConfirmModal-NTQzFaZh.js";import{f as B}from"./utils-CSQe5d3I.js";import"./vendor-CH429gIm.js";import"./supabase-CWr6oBKi.js";const Q=()=>{const{user:t}=P(),{showSuccess:b,showError:p}=D(),[w,h]=n.useState(!0),[m,_]=n.useState(null),[d,S]=n.useState([]),[v,R]=n.useState([]),[o,A]=n.useState({totalServices:0,activeServices:0,pendingReservations:0,todayReservations:0}),[r,l]=n.useState({isOpen:!1,type:"approve",reservation:null,loading:!1});n.useEffect(()=>{t?.role==="terminal"&&t.port_id&&g()},[t]);const g=async()=>{if(t?.port_id)try{h(!0);const{data:s,error:i}=await c.from("ports").select("*").eq("id",t.port_id).single();if(i)throw i;_(s);const{data:a,error:x}=await c.from("services").select(`
          *,
          ports (*)
        `).eq("port_id",t.port_id).order("created_at",{ascending:!1});if(x)throw x;S(a||[]);const{data:j,error:f}=await c.from("reservations").select(`
          *,
          services!inner (
            *,
            ports (*)
          )
        `).eq("services.port_id",t.port_id).eq("terminal_approval","pending").order("created_at",{ascending:!1});if(f)throw f;R(j||[]);const O=new Date().toISOString().split("T")[0],{data:k}=await c.from("reservations").select("id, services!inner(port_id)").eq("services.port_id",t.port_id).eq("requested_date",O);A({totalServices:a?.length||0,activeServices:a?.filter(q=>q.availability).length||0,pendingReservations:j?.length||0,todayReservations:k?.length||0})}catch(s){const i=s instanceof Error?s.message:"Failed to fetch port data";p("Error",i)}finally{h(!1)}},C=async(s,i)=>{l(a=>({...a,loading:!0}));try{const{error:a}=await c.from("reservations").update({terminal_approval:i,terminal_approved_at:new Date().toISOString(),terminal_approved_by:t?.id,updated_at:new Date().toISOString()}).eq("id",s);if(a)throw a;b("Terminal Approval Updated",`Reservation has been ${i==="approved"?"approved":"rejected"} by terminal successfully.`),await g()}catch(a){const x=a instanceof Error?a.message:"Failed to update reservation";p("Error",x)}finally{l({isOpen:!1,type:"approve",reservation:null,loading:!1})}},u=s=>{switch(s){case"tugboat":return"🚢";case"bunkering":return"⛽";case"cleaning":return"🧽";case"maintenance":return"🔧";case"docking":return"🏗️";default:return"⚓"}};return!t||t.role!=="terminal"?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Access Denied"}),e.jsx("p",{className:"text-gray-500",children:"This page is only accessible to terminal operators."})]})}):t.port_id?w?e.jsx(E,{}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Port Operations"}),m&&e.jsxs("p",{className:"text-gray-600",children:["Managing operations for ",e.jsx("strong",{children:m.name})," (",m.code,")"]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(M,{className:"h-6 w-6 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Terminal Operator"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(T,{className:"h-8 w-8 text-blue-600"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Total Services"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:o.totalServices})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(y,{className:"h-8 w-8 text-green-600"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Active Services"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:o.activeServices})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx(N,{className:"h-8 w-8 text-yellow-600"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Pending Approvals"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:o.pendingReservations})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx($,{className:"h-8 w-8 text-purple-600"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-600",children:"Today's Reservations"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:o.todayReservations})]})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Pending Reservation Approvals"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Review and approve reservation requests for your port"})]}),v.length===0?e.jsxs("div",{className:"px-6 py-8 text-center",children:[e.jsx(N,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No pending reservations"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"All reservations have been processed."})]}):e.jsx("div",{className:"divide-y divide-gray-200",children:v.map(s=>e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-2xl",children:u(s.services?.type||"tugboat")}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:s.ship_name}),e.jsx(z,{status:s.status,terminalApproval:s.terminal_approval||"pending",providerApproval:s.provider_approval||"pending",userRole:"terminal",size:"sm"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.services?.name," • ",B(new Date(s.requested_date),"MMM dd, yyyy")," at ",s.requested_time]}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Duration: ",s.duration_hours,"h",s.captain_notes&&` • Notes: ${s.captain_notes}`]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>l({isOpen:!0,type:"approve",reservation:s,loading:!1}),className:"px-3 py-1 text-xs font-medium text-green-600 bg-green-50 rounded-full hover:bg-green-100",children:e.jsx(y,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>l({isOpen:!0,type:"reject",reservation:s,loading:!1}),className:"px-3 py-1 text-xs font-medium text-red-600 bg-red-50 rounded-full hover:bg-red-100",children:e.jsx(I,{className:"h-4 w-4"})})]})]})},s.id))})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Port Services"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Services available at your port"})]}),e.jsxs("button",{onClick:()=>window.location.hash="#/management",className:"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700",children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Manage Services"]})]})}),d.length===0?e.jsxs("div",{className:"px-6 py-8 text-center",children:[e.jsx(L,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No services available"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"Create your first service to get started."})]}):e.jsxs("div",{className:"divide-y divide-gray-200",children:[d.slice(0,5).map(s=>e.jsx("div",{className:"px-6 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-2xl",children:u(s.type)}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:s.name}),e.jsx("p",{className:"text-sm text-gray-600 capitalize",children:s.type}),s.price_per_hour&&e.jsxs("p",{className:"text-xs text-gray-500",children:["$",s.price_per_hour,"/hour"]})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.availability?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.availability?"Available":"Unavailable"})})]})},s.id)),d.length>5&&e.jsx("div",{className:"px-6 py-4 text-center",children:e.jsxs("button",{onClick:()=>window.location.hash="#/management",className:"text-sm text-blue-600 hover:text-blue-800",children:["View all ",d.length," services →"]})})]})]}),e.jsx(F,{isOpen:r.isOpen,onClose:()=>l({isOpen:!1,type:"approve",reservation:null,loading:!1}),onConfirm:()=>r.reservation&&C(r.reservation.id,r.type==="approve"?"approved":"rejected"),title:r.type==="approve"?"Approve Reservation":"Reject Reservation",message:`Are you sure you want to ${r.type==="approve"?"approve":"reject"} the reservation for ${r.reservation?.ship_name}?`,type:r.type==="approve"?"success":"danger",confirmText:r.type==="approve"?"Approve":"Reject",loading:r.loading})]}):e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"No Port Assigned"}),e.jsx("p",{className:"text-gray-500",children:"You are not assigned to any port. Please contact an administrator."})]})})};export{Q as default};
