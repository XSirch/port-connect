import{a as A,j as e,s as C,u as P,L as z}from"./index-NMPGEa1P.js";import{r as i,X as E,o as F,S as M,j as L,d as D,e as I,p as $}from"./ui-FliD9Jbj.js";import{S as B}from"./SmartStatusBadge-Di3sCBb7.js";import{C as T}from"./ConfirmModal-CsTdeKkB.js";import{f as U}from"./utils-CSQe5d3I.js";import"./vendor-CH429gIm.js";import"./supabase-CWr6oBKi.js";const H=({isOpen:t,onClose:d,reservation:o,onSuccess:x})=>{const{showSuccess:y,showError:b}=A(),[p,c]=i.useState(!1),[h,g]=i.useState("");if(!t||!o)return null;const v=async()=>{if(o){c(!0);try{const{error:l}=await C.from("reservations").update({status:"cancelled",cancelled_at:new Date().toISOString(),cancellation_reason:h.trim()||null}).eq("id",o.id);if(l)throw l;y("Reservation Cancelled","Your reservation has been cancelled successfully. The service provider has been notified."),x(),d(),g("")}catch(l){const a=l instanceof Error?l.message:"Failed to cancel reservation";b("Cancellation Failed",a)}finally{c(!1)}}};return o.status!=="cancelled"&&o.status!=="completed"?e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:d}),e.jsxs("div",{className:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full",children:[e.jsx("div",{className:"bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4",children:e.jsxs("div",{className:"sm:flex sm:items-start",children:[e.jsx("div",{className:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10",children:e.jsx(F,{className:"h-6 w-6 text-red-600"})}),e.jsxs("div",{className:"mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left flex-1",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900",id:"modal-title",children:"Cancel Reservation"}),e.jsxs("div",{className:"mt-2",children:[e.jsxs("p",{className:"text-sm text-gray-500 mb-4",children:["Are you sure you want to cancel your reservation for ",e.jsx("strong",{children:o.ship_name}),"? This action cannot be undone and the service provider will be notified."]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"cancellation-reason",className:"block text-sm font-medium text-gray-700",children:"Reason for cancellation (optional)"}),e.jsx("textarea",{id:"cancellation-reason",rows:3,value:h,onChange:l=>g(l.target.value),placeholder:"Please provide a reason for cancelling this reservation...",className:"block w-full border-gray-300 rounded-md shadow-sm focus:ring-red-500 focus:border-red-500 sm:text-sm",maxLength:500}),e.jsxs("p",{className:"text-xs text-gray-500",children:[h.length,"/500 characters"]})]})]})]})]})}),e.jsxs("div",{className:"bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse",children:[e.jsx("button",{type:"button",disabled:p,onClick:v,className:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:p?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent mr-2"}),"Cancelling..."]}):"Cancel Reservation"}),e.jsx("button",{type:"button",disabled:p,onClick:d,className:"mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed",children:"Keep Reservation"})]})]})]})}):e.jsx("div",{className:"fixed inset-0 z-50 overflow-y-auto","aria-labelledby":"modal-title",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0",children:[e.jsx("div",{className:"fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity","aria-hidden":"true",onClick:d}),e.jsx("div",{className:"inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full",children:e.jsxs("div",{className:"bg-white px-4 pt-5 pb-4 sm:p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg leading-6 font-medium text-gray-900",children:"Cannot Cancel Reservation"}),e.jsx("button",{onClick:d,className:"text-gray-400 hover:text-gray-600",children:e.jsx(E,{className:"h-5 w-5"})})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["This reservation cannot be cancelled because it is already ",o.status,"."]}),e.jsx("div",{className:"mt-4",children:e.jsx("button",{onClick:d,className:"w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500",children:"Close"})})]})})]})})},W=()=>{const{user:t}=P(),{showSuccess:d,showError:o}=A(),[x,y]=i.useState([]),[b,p]=i.useState(!0),[c,h]=i.useState("all"),[g,v]=i.useState(null),[N,l]=i.useState(""),[a,m]=i.useState({isOpen:!1,type:"confirm",reservation:null,loading:!1}),[_,k]=i.useState({isOpen:!1,reservation:null}),j=i.useCallback(async()=>{if(t)try{p(!0);let s=C.from("reservations").select(`
          *,
          services!inner (
            *,
            ports (*)
          )
        `);t.role==="provider"?s=s.eq("services.provider_id",t.id):t.role==="captain"?s=s.eq("captain_id",t.id):t.role==="terminal"&&(s=s.eq("services.port_id",t.port_id)),c!=="all"&&(s=s.eq("status",c)),s=s.order("created_at",{ascending:!1});const{data:r,error:u}=await s;if(u)throw u;y(r||[])}catch{o("Failed to load reservations","Please refresh the page and try again")}finally{p(!1)}},[t,c]);i.useEffect(()=>{j()},[j]);const w=async(s,r,u)=>{m(n=>({...n,loading:!0}));try{if(!t)throw new Error("User not authenticated");let n={},f="";if(r==="complete"){if(t.role!=="provider")throw new Error("Only providers can mark reservations as complete");n={status:"completed",provider_notes:u},f="Reservation marked as completed!"}else{const O=new Date().toISOString();if(t.role==="terminal")n={terminal_approval:r==="approve"?"approved":"rejected",terminal_approved_at:r==="approve"?O:null,terminal_approved_by:r==="approve"?t.id:null,terminal_notes:u},f=r==="approve"?"Terminal approval granted!":"Terminal approval rejected!";else if(t.role==="provider")n={provider_approval:r==="approve"?"approved":"rejected",provider_approved_at:r==="approve"?O:null,provider_approved_by:r==="approve"?t.id:null,provider_notes:u},f=r==="approve"?"Provider approval granted!":"Provider approval rejected!";else throw new Error("Only terminal operators and providers can approve reservations")}const{error:S}=await C.from("reservations").update(n).eq("id",s);if(S)throw S;d("Status Updated",f),j(),v(null),l(""),m({isOpen:!1,type:"confirm",reservation:null,loading:!1})}catch(n){const f=n instanceof Error?n.message:"An unexpected error occurred";o("Failed to update reservation",f)}finally{m(n=>({...n,loading:!1}))}},q=s=>{switch(s){case"tugboat":return"🚢";case"bunkering":return"⛽";case"cleaning":return"🧽";case"maintenance":return"🔧";case"docking":return"🏗️";default:return"⚓"}},R=s=>t?.role==="provider"?s.services?.provider_id===t.id:t?.role==="terminal";return b?e.jsx("div",{className:"h-64",children:e.jsx(z,{size:"lg",text:"Loading reservations..."})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:t?.role==="captain"?"My Reservations":"Reservation Management"}),e.jsx("div",{className:"flex items-center space-x-4",children:e.jsxs("select",{value:c,onChange:s=>h(s.target.value),className:"text-sm border-gray-300 rounded-md",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"confirmed",children:"Confirmed"}),e.jsx("option",{value:"completed",children:"Completed"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:["pending","confirmed","completed","cancelled","all"].map(s=>e.jsxs("div",{className:"bg-white rounded-lg shadow p-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-600 capitalize",children:s==="all"?"Total":s}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:s==="all"?x.length:x.filter(r=>r.status===s).length})]},s))}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsx("div",{className:"divide-y divide-gray-200",children:x.length===0?e.jsxs("div",{className:"px-6 py-8 text-center",children:[e.jsx(M,{className:"mx-auto h-12 w-12 text-gray-400"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No reservations"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No reservations found for the selected filter."})]}):x.map(s=>e.jsxs("div",{className:"px-6 py-4 hover:bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"text-2xl",children:q(s.services?.type||"tugboat")}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900",children:s.ship_name}),s.ship_imo&&e.jsxs("span",{className:"text-xs text-gray-500",children:["IMO: ",s.ship_imo]})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.services?.name," • ",s.services?.ports?.name]}),e.jsxs("div",{className:"flex items-center mt-1 text-xs text-gray-500 space-x-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(L,{className:"h-3 w-3 mr-1"}),U(new Date(s.requested_date),"MMM dd, yyyy")]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(D,{className:"h-3 w-3 mr-1"}),s.requested_time," (",s.duration_hours,"h)"]}),t?.role!=="captain"&&e.jsxs("div",{className:"flex items-center",children:[e.jsx(M,{className:"h-3 w-3 mr-1"}),s.users?.name]})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[s.total_cost&&e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["$",s.total_cost]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Total"})]}),e.jsx(B,{status:s.status,terminalApproval:s.terminal_approval||"pending",providerApproval:s.provider_approval||"pending",userRole:t?.role||"captain",size:"sm",showDetailOnHover:!0}),R(s)&&s.status==="pending"&&e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>m({isOpen:!0,type:"confirm",reservation:s,loading:!1}),className:"p-2 text-green-600 hover:bg-green-50 rounded-full",title:"Confirm",children:e.jsx(I,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>{v(s),l("")},className:"p-2 text-red-600 hover:bg-red-50 rounded-full",title:"Reject",children:e.jsx(E,{className:"h-4 w-4"})})]}),s.status==="confirmed"&&R(s)&&e.jsx("button",{onClick:()=>m({isOpen:!0,type:"complete",reservation:s,loading:!1}),className:"px-3 py-1 text-xs font-medium text-blue-600 bg-blue-50 rounded-full hover:bg-blue-100",children:"Mark Complete"}),t?.role==="captain"&&s.captain_id===t.id&&s.status!=="cancelled"&&s.status!=="completed"&&e.jsxs("button",{onClick:()=>k({isOpen:!0,reservation:s}),className:"px-3 py-1 text-xs font-medium text-red-600 bg-red-50 rounded-full hover:bg-red-100 flex items-center gap-1",title:"Cancel Reservation",children:[e.jsx($,{className:"h-3 w-3"}),"Cancel"]})]})]}),(s.notes||s.provider_notes)&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-gray-100",children:[s.notes&&e.jsxs("div",{className:"text-sm text-gray-600 mb-2",children:[e.jsx("strong",{children:"Customer Notes:"})," ",s.notes]}),s.provider_notes&&e.jsxs("div",{className:"text-sm text-gray-600",children:[e.jsx("strong",{children:"Provider Notes:"})," ",s.provider_notes]})]})]},s.id))})}),g&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Reject Reservation"})}),e.jsxs("div",{className:"p-6",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Please provide a reason for rejecting this reservation:"}),e.jsx("textarea",{rows:4,value:N,onChange:s=>l(s.target.value),placeholder:"Reason for rejection...",className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-end space-x-4",children:[e.jsx("button",{onClick:()=>{v(null),l("")},className:"px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:()=>w(g.id,"reject",N),className:"px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700",children:"Reject Reservation"})]})]})}),e.jsx(T,{isOpen:a.isOpen&&a.type==="confirm",onClose:()=>m({isOpen:!1,type:"confirm",reservation:null,loading:!1}),onConfirm:()=>a.reservation&&w(a.reservation.id,"approve"),title:"Confirm Reservation",message:`Are you sure you want to confirm the reservation for ${a.reservation?.ship_name}?`,type:"success",confirmText:"Confirm",loading:a.loading}),e.jsx(T,{isOpen:a.isOpen&&a.type==="complete",onClose:()=>m({isOpen:!1,type:"complete",reservation:null,loading:!1}),onConfirm:()=>a.reservation&&w(a.reservation.id,"complete"),title:"Mark as Complete",message:`Are you sure you want to mark the reservation for ${a.reservation?.ship_name} as completed?`,type:"success",confirmText:"Mark Complete",loading:a.loading}),e.jsx(H,{isOpen:_.isOpen,onClose:()=>k({isOpen:!1,reservation:null}),reservation:_.reservation,onSuccess:j})]})};export{W as default};
